version: '3.8'

services:
  # Chimaera Runtime Node 1
  chimaera-node1:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: chimaera-runtime:latest
    container_name: chimaera-node1
    hostname: chimaera-node1

    # Shared memory size - CRITICAL for Chimaera runtime
    # Must be >= sum of all segment sizes (main + client_data + runtime_data)
    # Default: 2GB (matches CHI_SHM_SIZE default)
    shm_size: 2gb

    # Network configuration
    ports:
      - "5555:5555"  # ZeroMQ port for inter-node communication
    networks:
      chimaera-net:
        ipv4_address: 172.20.0.10

    # Environment variables for runtime configuration
    environment:
      # Worker configuration
      - CHI_SCHED_WORKERS=8
      - CHI_PROCESS_REAPER_WORKERS=1

      # Memory segment sizes (can use suffixes: G, M, K or raw bytes)
      - CHI_MAIN_SEGMENT_SIZE=1G
      - CHI_CLIENT_DATA_SEGMENT_SIZE=512M
      - CHI_RUNTIME_DATA_SEGMENT_SIZE=512M

      # Network configuration
      - CHI_ZMQ_PORT=5555

      # Logging configuration
      - CHI_LOG_LEVEL=info

      # Performance tuning
      - CHI_STACK_SIZE=65536
      - CHI_QUEUE_DEPTH=10000

      # Runtime configuration
      - CHI_HEARTBEAT_INTERVAL=1000
      - CHI_TASK_TIMEOUT=30000

      # Total shared memory size (must match shm_size above)
      - CHI_SHM_SIZE=2147483648  # 2GB in bytes

      # Optional: Path to hostfile inside container
      - CHI_HOSTFILE=/etc/chimaera/hostfile

    # Mount custom configuration (optional)
    volumes:
      # Option 1: Mount custom config file (uncomment to use)
      # - ./chimaera_config.yaml:/etc/chimaera/chimaera_config.yaml:ro

      # Option 2: Mount hostfile with cluster node IPs
      - ./hostfile:/etc/chimaera/hostfile:ro

      # Mount log directory for persistence
      - chimaera-node1-logs:/var/log/chimaera

    # Keep container running as daemon
    restart: unless-stopped

    # IPC mode for shared memory (use host or shareable)
    # Use 'host' for single-node deployment
    # Use 'shareable' for multi-container deployments
    ipc: shareable

  # Chimaera Runtime Node 2
  chimaera-node2:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: chimaera-runtime:latest
    container_name: chimaera-node2
    hostname: chimaera-node2
    shm_size: 2gb

    ports:
      - "5556:5555"  # Map to different host port
    networks:
      chimaera-net:
        ipv4_address: 172.20.0.11

    environment:
      - CHI_SCHED_WORKERS=8
      - CHI_PROCESS_REAPER_WORKERS=1
      - CHI_MAIN_SEGMENT_SIZE=1G
      - CHI_CLIENT_DATA_SEGMENT_SIZE=512M
      - CHI_RUNTIME_DATA_SEGMENT_SIZE=512M
      - CHI_ZMQ_PORT=5555
      - CHI_LOG_LEVEL=info
      - CHI_STACK_SIZE=65536
      - CHI_QUEUE_DEPTH=10000
      - CHI_HEARTBEAT_INTERVAL=1000
      - CHI_TASK_TIMEOUT=30000
      - CHI_SHM_SIZE=2147483648
      - CHI_HOSTFILE=/etc/chimaera/hostfile

    volumes:
      - ./hostfile:/etc/chimaera/hostfile:ro
      - chimaera-node2-logs:/var/log/chimaera

    restart: unless-stopped
    ipc: shareable

  # Chimaera Runtime Node 3
  chimaera-node3:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: chimaera-runtime:latest
    container_name: chimaera-node3
    hostname: chimaera-node3
    shm_size: 2gb

    ports:
      - "5557:5555"  # Map to different host port
    networks:
      chimaera-net:
        ipv4_address: 172.20.0.12

    environment:
      - CHI_SCHED_WORKERS=8
      - CHI_PROCESS_REAPER_WORKERS=1
      - CHI_MAIN_SEGMENT_SIZE=1G
      - CHI_CLIENT_DATA_SEGMENT_SIZE=512M
      - CHI_RUNTIME_DATA_SEGMENT_SIZE=512M
      - CHI_ZMQ_PORT=5555
      - CHI_LOG_LEVEL=info
      - CHI_STACK_SIZE=65536
      - CHI_QUEUE_DEPTH=10000
      - CHI_HEARTBEAT_INTERVAL=1000
      - CHI_TASK_TIMEOUT=30000
      - CHI_SHM_SIZE=2147483648
      - CHI_HOSTFILE=/etc/chimaera/hostfile

    volumes:
      - ./hostfile:/etc/chimaera/hostfile:ro
      - chimaera-node3-logs:/var/log/chimaera

    restart: unless-stopped
    ipc: shareable

# Docker network for Chimaera cluster
networks:
  chimaera-net:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16

# Persistent volumes for logs
volumes:
  chimaera-node1-logs:
  chimaera-node2-logs:
  chimaera-node3-logs:
