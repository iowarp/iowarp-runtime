version: '3.8'

services:
  # Node 1 - Primary runtime node
  chimaera-node1:
    image: iowarp/iowarp-runtime:latest
    container_name: chimaera-node1
    hostname: chimaera-node1
    networks:
      chimaera-cluster:
        ipv4_address: 172.20.0.10
    ports:
      - "5555:5555"
    environment:
      # WRP_RUNTIME_CONF is set to /etc/wrp_runtime/wrp_runtime_config.yaml by default
      # Override with CHI_SERVER_CONF to use a different configuration file
      # - CHI_SERVER_CONF=/etc/wrp_runtime/custom_config.yaml
    volumes:
      # Mount hostfile for cluster configuration
      - ./hostfile:/etc/chimaera/hostfile:ro
      # Optional: mount custom configuration (will override default)
      # - ./chimaera_config.yaml:/etc/wrp_runtime/wrp_runtime_config.yaml:ro
      # Optional: mount log directory
      - chimaera-logs-node1:/tmp
    shm_size: 2gb  # Must be >= sum of all segment sizes
    restart: unless-stopped

  # Node 2 - Secondary runtime node
  chimaera-node2:
    image: iowarp/iowarp-runtime:latest
    container_name: chimaera-node2
    hostname: chimaera-node2
    networks:
      chimaera-cluster:
        ipv4_address: 172.20.0.11
    ports:
      - "5556:5555"
    environment:
      # WRP_RUNTIME_CONF is set to /etc/wrp_runtime/wrp_runtime_config.yaml by default
      # Override with CHI_SERVER_CONF to use a different configuration file
      # - CHI_SERVER_CONF=/etc/wrp_runtime/custom_config.yaml
    volumes:
      - ./hostfile:/etc/chimaera/hostfile:ro
      # Optional: mount custom configuration (will override default)
      # - ./chimaera_config.yaml:/etc/wrp_runtime/wrp_runtime_config.yaml:ro
      - chimaera-logs-node2:/tmp
    shm_size: 2gb
    restart: unless-stopped

  # Node 3 - Tertiary runtime node
  chimaera-node3:
    image: iowarp/iowarp-runtime:latest
    container_name: chimaera-node3
    hostname: chimaera-node3
    networks:
      chimaera-cluster:
        ipv4_address: 172.20.0.12
    ports:
      - "5557:5555"
    environment:
      # WRP_RUNTIME_CONF is set to /etc/wrp_runtime/wrp_runtime_config.yaml by default
      # Override with CHI_SERVER_CONF to use a different configuration file
      # - CHI_SERVER_CONF=/etc/wrp_runtime/custom_config.yaml
    volumes:
      - ./hostfile:/etc/chimaera/hostfile:ro
      # Optional: mount custom configuration (will override default)
      # - ./chimaera_config.yaml:/etc/wrp_runtime/wrp_runtime_config.yaml:ro
      - chimaera-logs-node3:/tmp
    shm_size: 2gb
    restart: unless-stopped

networks:
  chimaera-cluster:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16

volumes:
  chimaera-logs-node1:
  chimaera-logs-node2:
  chimaera-logs-node3:
