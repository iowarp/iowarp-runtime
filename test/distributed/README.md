# IoWarp Distributed Networking Tests

This directory contains infrastructure for testing the IoWarp runtime's distributed networking capabilities (Send/Recv methods) across multiple nodes using Docker containers.

## Overview

The distributed test setup creates two Docker containers (`node1` and `node2`) that run IoWarp runtimes and communicate over a Docker network. This tests the ZeroMQ-based Send/Recv implementation.

## Directory Structure

```
test/distributed/
├── README.md          # This file
└── shared/            # Shared directory mounted in both containers
    └── hostfile       # Generated hostfile with container IPs
```

## Prerequisites

1. **Docker and Docker Compose** installed
2. **IoWarp runtime built** in `build/` directory
3. **ppi-jarvis-mods** directory at `~/.ppi-jarvis-mods` with:
   - hermes-shm package built and installed
4. **IoWarp dependencies** available (see main README)

## Quick Start

Run the distributed networking test:

```bash
# Build images and run test
./run-distributed-test.sh --build

# Or use existing images
./run-distributed-test.sh

# Cleanup after test
./run-distributed-test.sh --cleanup
```

## Test Components

### 1. Docker Compose Configuration

`docker-compose.distributed.yml` defines two services:

- **node1** (172.28.0.2): Primary runtime node
- **node2** (172.28.0.3): Secondary runtime node

Both containers:
- Run on a bridge network (172.28.0.0/16)
- Mount the workspace and shared directories
- Have 2GB shared memory for IPC
- Run jarvis for orchestration

### 2. Docker Image

`Dockerfile.distributed` creates a container with:
- IoWarp dependencies (from `iowarp/iowarp-deps:latest`)
- ppi-jarvis-cd (branch `36-refactor-with-ai`)
- Network utilities for testing
- Shared directory setup

### 3. Test Script

`run-distributed-test.sh` orchestrates the test:

1. Creates hostfile with container IPs
2. Starts both containers
3. Initializes jarvis on each node
4. Loads and runs the runtime pipeline
5. Verifies runtimes are communicating
6. Cleans up (optional)

### 4. Test Pipeline

`test/jarvis_wrp_runtime/pipelines/distributed_network_test.yaml`:
- Configures runtime for distributed execution
- Uses debug logging for networking details
- Runs on both nodes from hostfile

## Hostfile Format

The hostfile (`shared/hostfile`) contains node definitions:

```
# Format: hostname IP_address
node1 172.28.0.2
node2 172.28.0.3
```

This file is automatically generated by `run-distributed-test.sh` and shared between containers.

## Manual Testing

You can manually interact with the containers:

```bash
# Start containers
docker compose -f docker-compose.distributed.yml up -d

# Access node1
docker exec -it iowarp-node1 bash

# Access node2
docker exec -it iowarp-node2 bash

# In each container, you can:
cd /workspace
jarvis init
jarvis ppl load yaml test/jarvis_wrp_runtime/pipelines/distributed_network_test.yaml
jarvis ppl run

# Stop containers
docker compose -f docker-compose.distributed.yml down
```

## Verifying Network Communication

Once runtimes are running, you can verify communication:

```bash
# Check runtime processes
docker exec iowarp-node1 ps aux | grep chimaera_start_runtime
docker exec iowarp-node2 ps aux | grep chimaera_start_runtime

# Check ZeroMQ ports
docker exec iowarp-node1 netstat -tulpn | grep 5555
docker exec iowarp-node2 netstat -tulpn | grep 5555

# View runtime logs (if available)
docker exec iowarp-node1 tail -f /workspace/build/*.log
```

## Network Architecture

```
┌─────────────────────────────────────────────┐
│ Docker Host                                  │
│                                              │
│  ┌─────────────────────────────────────┐   │
│  │ iowarp-net (172.28.0.0/16)          │   │
│  │                                      │   │
│  │  ┌──────────────┐  ┌──────────────┐ │   │
│  │  │ node1        │  │ node2        │ │   │
│  │  │ 172.28.0.2   │◄─┤ 172.28.0.3   │ │   │
│  │  │              │  │              │ │   │
│  │  │ Runtime      │  │ Runtime      │ │   │
│  │  │ ZMQ:5555     │  │ ZMQ:5555     │ │   │
│  │  └──────────────┘  └──────────────┘ │   │
│  │                                      │   │
│  │  Shared Volume: test/distributed/   │   │
│  │    - hostfile                        │   │
│  │    - jarvis config                   │   │
│  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

## Troubleshooting

### Containers won't start
- Check Docker is running: `docker ps`
- Check for port conflicts: `docker ps -a | grep iowarp`
- Remove old containers: `docker-compose -f docker-compose.distributed.yml down -v`

### Network connectivity issues
- Verify network exists: `docker network ls | grep iowarp`
- Test ping between containers: `docker exec iowarp-node1 ping 172.28.0.3`

### Runtime fails to start
- Check build artifacts: `ls build/bin/chimaera_start_runtime`
- Verify environment: `docker exec iowarp-node1 env | grep HERMES`
- Check logs in container: `docker exec iowarp-node1 tail -f /workspace/build/*.log`

### Jarvis errors
- Verify jarvis is installed: `docker exec iowarp-node1 which jarvis`
- Check jarvis version: `docker exec iowarp-node1 jarvis --version`
- Verify PYTHONPATH: `docker exec iowarp-node1 echo $PYTHONPATH`

## Future Enhancements

1. **Actual Send/Recv Test**: Add C++ test code that exercises Send/Recv methods
2. **Multi-node Support**: Extend to 3+ nodes for more complex scenarios
3. **Performance Testing**: Add throughput and latency measurements
4. **Failure Scenarios**: Test node failures and recovery
5. **CI Integration**: Automate distributed tests in CI/CD pipeline

## Related Files

- `docker-compose.distributed.yml` - Container orchestration
- `Dockerfile.distributed` - Container image definition
- `run-distributed-test.sh` - Test orchestration script
- `test/jarvis_wrp_runtime/pipelines/distributed_network_test.yaml` - Runtime configuration

## References

- [IoWarp Runtime Documentation](../../doc/)
- [Jarvis Documentation](https://github.com/iowarp/ppi-jarvis-cd)
- [Docker Compose Documentation](https://docs.docker.com/compose/)
